name: Cost Cleanup (DISABLED)

on:
  # schedule:
  #   - cron: '0 9 * * *'  # Daily at 9 AM UTC - DISABLED
  workflow_dispatch:     # Manual trigger only

jobs:
  cleanup:
    if: false  # Workflow disabled
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Check costs and cleanup
      run: |
        # Get current cost
        COST=$(az rest --method POST --url "https://management.azure.com/subscriptions/$(az account show --query id -o tsv)/providers/Microsoft.CostManagement/query?api-version=2021-10-01" --body '{"type":"ActualCost","timeframe":"MonthToDate","dataset":{"aggregation":{"totalCost":{"name":"PreTaxCost","function":"Sum"}}}}' --query "properties.rows[0][0]" -o tsv)
        
        echo "Current cost: ¥$COST"
        
        # If over 100 yen, cleanup
        if (( $(echo "$COST > 100" | bc -l) )); then
          echo "Cost exceeded ¥100! Cleaning up..."
          
          # Delete expensive resource groups
          az group delete --name TestResourceGroup --yes --no-wait || true
          az group delete --name dns-alias-rg --yes --no-wait || true
          
          # Stop all VMs
          az vm deallocate --ids $(az vm list --query "[].id" -o tsv) --no-wait || true
          
          echo "Cleanup completed!"
        fi